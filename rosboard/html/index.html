<!doctype html>
<html>
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
        <link href="css/material-icons.css" media="all" rel="stylesheet" type="text/css">
        <script type="text/javascript" src="js/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s="></script>
        <link rel="stylesheet" href="css/material.indigo-blue.min.css" />
        <link rel="stylesheet" href="css/uPlot.min.css">
        <link rel="stylesheet" href="css/leaflet.css">
        <link href="css/index.css" media="all" rel="stylesheet" type="text/css">
        
        <script type="text/javascript" src="js/json5.min.js"></script>
        <script type="text/javascript" src="js/uPlot.iife.min.js"></script>
        <script type="text/javascript" src="js/jquery.transit.min.js"></script>
        <script type="text/javascript" src="js/masonry.pkgd.min.js"></script>
        <script type="text/javascript" src="js/eventemitter2.min.js"></script>
        <script text="text/javascript" src="js/import-helper.js"></script>
        <script type="text/javascript" src="js/material.min.js" defer></script>
        <script type="text/javascript" src="js/leaflet.js"></script>        
        <script type="text/javascript" src="js/gl-matrix.js"></script>
        <script type="text/javascript" src="js/litegl.min.js"></script>
        <script type="text/javascript" src="js/index.js" defer></script>

        <title>Autonomous Oil Palm Harvesting Robot System</title>
        
        <style>
            /* Smaller button styles */
            .header-button {
                margin-right: 12px !important;
                padding: 0 12px !important;
                border-radius: 4px !important;
                height: 36px !important;
                line-height: 36px !important;
                font-size: 14px !important;
                min-width: auto !important;
            }
            
            .header-button .material-icons {
                font-size: 18px !important;
                margin-right: 6px !important;
            }
            
            /* Logout button styling */
            .logout-button {
                color: white !important;
                min-width: 40px !important;
                padding: 0 8px !important;
                margin-right: 0 !important;
            }
            
            .logout-button .material-icons {
                font-size: 20px !important;
                margin-right: 0 !important;
            }
            
            /* Header navigation styling */
            .header-nav {
                display: flex !important;
                align-items: center !important;
            }
        </style>
    </head>
    <body>
        <div class="mdl-layout mdl-js-layout mdl-layout--fixed-header">
          <header class="mdl-layout__header">
            <div class="mdl-layout__header-row">
              
              <span class="mdl-layout-title">Autonomous Oil Palm Harvesting Robot System</span>
              
              <div class="mdl-layout-spacer"></div>
              
              <!-- Updated container with navigation class -->
              <nav class="header-nav">
                <span id="admin-button-container"></span>
                <!-- Logout Button - UPDATED TO ABSOLUTE URL -->
                <a class="mdl-navigation__link logout-button" href="http://localhost:8000/login" title="Logout">
                    <i class="material-icons">power_settings_new</i>
                </a>
              </nav>
              
            </div>
          </header>
          <div class="mdl-layout__drawer">
            <nav id="topics-nav" class="mdl-navigation">
                <div id="topics-nav-system-title" class="topics-nav-title">System</div>
                <div id="topics-nav-system"></div>
                <div id="topics-nav-ros-title" class="topics-nav-title">ROS topics</div>
                <div id="topics-nav-ros"></div>
                <div style="opacity:0.3;" id="topics-nav-unsupported"></div>
            </nav>
          </div>
          <main class="mdl-layout__content">
            <div class="page-content">
              <div class="grid">
              </div>
            </div>
          </main>
        </div>
        
  <div id="demo-toast-example" class="mdl-js-snackbar mdl-snackbar">
    <div class="mdl-snackbar__text"></div>
    <button class="mdl-snackbar__action" type="button"></button>
  </div>

    </body>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const container = document.getElementById('admin-button-container');
            const LOGIN_SERVER_URL = 'http://localhost:8000';

            // Function to fetch session data from the Login Server
            fetch(`${LOGIN_SERVER_URL}/api/get_session`, {credentials: 'include'})
                .then(response => {
                    // Check for network errors, 401 Unauthorized, or 403 Forbidden
                    if (response.status === 401 || response.status === 403 || !response.ok) {
                        // User not logged in/session expired, redirect them - UPDATED PATH
                        window.location.href = `${LOGIN_SERVER_URL}/login`;
                        return null; // Stop processing
                    }
                    return response.json();
                })
                .then(user => {
                    if (!user) return; // Stop if redirect happened above

                    // Create Robot Control Button (visible to all logged-in users)
                    const robotControlButton = document.createElement('a');
                    robotControlButton.href = '/robot-control.html';
                    robotControlButton.textContent = 'Robot Control';
                    robotControlButton.className = 'mdl-button mdl-js-button mdl-button--raised header-button';
                    robotControlButton.style.backgroundColor = '#4caf50'; // Green color
                    robotControlButton.style.color = 'white';
                    
                    const robotIcon = document.createElement('i');
                    robotIcon.className = 'material-icons';
                    robotIcon.textContent = 'smart_toy';
                    robotControlButton.prepend(robotIcon);
                    
                    container.appendChild(robotControlButton);

                    // Create Admin Button (only for admin users)
                    if (user && user.role === 'admin') {
                        
                        const adminButton = document.createElement('a');
                        adminButton.href = `${LOGIN_SERVER_URL}/admin`;
                        adminButton.textContent = 'Admin Panel';
                        adminButton.className = 'mdl-button mdl-js-button mdl-button--raised mdl-button--colored header-button';
                        
                        const adminIcon = document.createElement('i');
                        adminIcon.className = 'material-icons';
                        adminIcon.textContent = 'admin_panel_settings';
                        
                        adminButton.prepend(adminIcon);
                        
                        
                        container.appendChild(adminButton);
                    }

                    // Ensure MDL components are upgraded
                    if (componentHandler) {
                        componentHandler.upgradeAllRegistered();
                    }
                })
                .catch(error => {
                    console.error("Network Error when checking session:", error);
                    
                    // UPDATED PATH - Fixed to use /login instead of /web/login.html
                    window.location.href = `${LOGIN_SERVER_URL}/login`; 
                });
        });

        // Enhanced cleanup for unwanted text nodes and title
        document.addEventListener('DOMContentLoaded', function() {
            function enforceCorrectTitle() {
                const layoutTitle = document.querySelector('.mdl-layout-title');
                const desiredTitle = 'Autonomous Oil Palm Harvesting Robot System';
                
                if (layoutTitle) {
                    
                    let currentTitle = layoutTitle.textContent;
                    if (currentTitle.includes('ROSboard:')) {
                        currentTitle = currentTitle.replace('ROSboard:', '').trim();
                    }
                    if (currentTitle !== desiredTitle) {
                        layoutTitle.textContent = desiredTitle;
                    }
                }
                

                if (document.title !== desiredTitle) {
                    document.title = desiredTitle;
                }
            }
            
            function removeUnwantedTextNodes() {
                
                const bodyChildren = document.body.childNodes;
                

                for (let i = bodyChildren.length - 1; i >= 0; i--) {
                    const node = bodyChildren[i];
                    

                    if (node.nodeType === Node.TEXT_NODE) {
                        const textContent = node.textContent;
                        

                        if (textContent.includes('Â&nbsp;') || 
                            textContent.trim() === 'Â' || 
                            textContent.includes('\u00A0') ||
                            textContent.trim() === '') {
                            console.log('Removing unwanted text node:', textContent);
                            node.remove();
                        }
                    }
                    

                    if (node.nodeType === Node.ELEMENT_NODE) {
                        if (node.tagName === 'TEXT' || 
                            (node.textContent && node.textContent.includes('Â&nbsp;'))) {
                            console.log('Removing unwanted element:', node);
                            node.remove();
                        }
                    }
                }
            }
            
            // Run cleanup immediately
            removeUnwantedTextNodes();
            enforceCorrectTitle();
            
            // Set up mutation observer to catch any dynamically added/changed content
            const observer = new MutationObserver(function(mutations) {
                let shouldCleanup = false;
                let shouldEnforceTitle = false;
                
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
                        mutation.addedNodes.forEach(function(node) {
                            if (node.nodeType === Node.TEXT_NODE && 
                                (node.textContent.includes('Â&nbsp;') || node.textContent.includes('\u00A0'))) {
                                shouldCleanup = true;
                            }
                        });
                    }
                    

                    if (mutation.type === 'characterData' && mutation.target.classList.contains('mdl-layout-title')) {
                        shouldEnforceTitle = true;
                    }
                });
                
                if (shouldCleanup) {
                    removeUnwantedTextNodes();
                }
                if (shouldEnforceTitle) {
                    enforceCorrectTitle();
                }
            });
            
            // Start observing for changes
            observer.observe(document.body, {
                childList: true,
                subtree: true,
                characterData: true
            });
            
            // Run cleanup multiple times to catch any delayed changes
            setTimeout(() => {
                removeUnwantedTextNodes();
                enforceCorrectTitle();
            }, 100);
            
            setTimeout(() => {
                removeUnwantedTextNodes();
                enforceCorrectTitle();
            }, 500);
            
            setTimeout(() => {
                removeUnwantedTextNodes();
                enforceCorrectTitle();
            }, 1000);
        });
    </script>
</html>
